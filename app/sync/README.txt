TODO: programming here is too defensive and ungly. Fix this!
